<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerosol Classifier Operational Range Calculator</title>
    
    <!-- MathJax Configuration -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script type="text/javascript">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$$','$$']],
                displayMath: [['\\[','\\]']],
                processEscapes: true
            }
        });
    </script>
    
    <!-- Other Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .card {
            margin: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .plot-container {
            height: 600px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- AAC Section -->
        <div class="card">
            <div class="card-header">
                <h2>AAC Operational Range Calculator</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="aac-qa">Aerosol Flow Rate ($$Q_{\mathrm{a}}$$) [L/min]:</label>
                            <input type="number" class="form-control" id="aac-qa" value="0.3" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="form-group mb-3">
                            <label for="aac-qsh">Sheath Flow Rate ($$Q_{\mathrm{sh}}$$) [L/min]:</label>
                            <input type="number" class="form-control" id="aac-qsh" value="3" min="2" max="15" step="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateAAC()">Calculate</button>
                    </div>
                    <div class="col-md-8">
                        <div id="aac-plot" class="plot-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function Cc(d, P, T) {
            const lambda = 0.066e-6;
            const A = 1.257;
            const B = 0.4;
            const C = 1.1;
            return 1 + (2 * lambda / d) * (A + B * Math.exp(-C * d / (2 * lambda)));
        }

        function AAC_Trapezoidal(Q_a_inp = 0.3, Q_sh_inp = 3) {
            try {
                const P = 101325;
                const T = 298.15;
                const mu = 1.81809e-5 * Math.pow(T / 293.15, 1.5) * (293.15 + 110.4) / (T + 110.4);

                const Q_a = Q_a_inp / 60000;
                const Q_sh = Q_sh_inp / 60000;
                const Q_sh_lb = 2 / 60000;
                const Q_sh_ub = 15 / 60000;
                const Q_sh_RB = 10 / 60000;

                const r_1 = 56e-3;
                const r_2 = 60e-3;
                const L = 0.206;

                const w_lb_i = 2 * Math.PI / 60 * 200;
                const w_ub_i = 2 * Math.PI / 60 * 7000;

                const steps = 500;
                const Q_sh_spa = numeric.linspace(Q_sh_lb, Q_sh_ub, steps);
                const R_t = Q_sh_spa.map(Q => Q / Q_a);
                const R_t_lb = Q_sh_lb / Q_a;
                const R_t_up = Q_sh_ub / Q_a;

                const w_low = Q_sh_spa.map(() => w_lb_i);
                const w_up = new Array(steps);

                for (let i = 0; i < steps; i++) {
                    const Q = Q_sh_spa[i];
                    if (Q < Q_sh_RB) {
                        w_up[i] = Math.min(w_ub_i, 723.7 - 9.87 * 60000 * Q);
                    } else {
                        w_up[i] = Math.min(w_ub_i, 875 - 25 * 60000 * Q);
                    }
                }

                const factor1 = w_low.map(w => (36 * mu) / (Math.PI * 1000 * Math.pow((r_1 + r_2), 2) * L * Math.pow(w, 2)));
                const factor2 = w_up.map(w => (36 * mu) / (Math.PI * 1000 * Math.pow((r_1 + r_2), 2) * L * Math.pow(w, 2)));

                function f1(d, Q_sh_val, factor2_val) {
                    return Math.pow(d, 2) * Cc(d, P, T) - (factor2_val * Q_sh_val);
                }

                function f2(d, Q_sh_val, factor1_val) {
                    return Math.pow(d, 2) * Cc(d, P, T) - (factor1_val * Q_sh_val);
                }

                function solve(func, guess, Q_sh_val, factor_val) {
                    const result = numeric.uncmin(
                        d => Math.pow(func(d, Q_sh_val, factor_val), 2),
                        [guess]
                    );
                    if (result.solution) {
                        return result.solution[0];
                    } else {
                        console.error('Optimization failed:', result);
                        return null;
                    }
                }

                const d_min = new Array(steps);
                const d_max = new Array(steps);

                for (let i = 0; i < steps; i++) {
                    d_min[i] = solve(f1, 1e-8, Q_sh_spa[i], factor2[i]);
                    d_max[i] = solve(f2, 1e-6, Q_sh_spa[i], factor1[i]);
                }

                const index = Q_sh_spa.reduce((prev, curr, i) => Math.abs(curr - Q_sh) < Math.abs(Q_sh_spa[prev] - Q_sh) ? i : prev, 0);
                const factor1_input = factor1[index];
                const factor2_input = factor2[index];

                const d_i = solve(f1, 1e-8, Q_sh, factor2_input);
                const d_o = solve(f2, 1e-6, Q_sh, factor1_input);

                console.log(`d_i (nm): ${d_i * 1e9}, d_o (nm): ${d_o * 1e9}`);

                const traceAACLower = {
                    x: d_min.map(d => d * 1e9),
                    y: R_t,
                    mode: 'lines',
                    name: 'AAC Lower Bound',
                    line: { color: 'blue' }
                };

                const traceAACUpper = {
                    x: d_max.map(d => d * 1e9),
                    y: R_t,
                    mode: 'lines',
                    name: 'AAC Upper Bound',
                    line: { color: 'blue' }
                };

                const traceAACHorizontalLower = {
                    x: [d_min[0] * 1e9, d_max[0] * 1e9],
                    y: [R_t_lb, R_t_lb],
                    mode: 'lines',
                    name: 'Lower R_t',
                    line: { color: 'blue', dash: 'dash' },
                    showlegend: false
                };

                const traceAACHorizontalUpper = {
                    x: [d_min[steps - 1] * 1e9, d_max[steps - 1] * 1e9],
                    y: [R_t_up, R_t_up],
                    mode: 'lines',
                    name: 'Upper R_t',
                    line: { color: 'blue', dash: 'dash' },
                    showlegend: false
                };

                const traceAACSelected = {
                    x: [d_i * 1e9, d_o * 1e9],
                    y: [Q_sh / Q_a, Q_sh / Q_a],
                    mode: 'lines',
                    name: 'Q_sh / Q_a',
                    line: { color: 'red', dash: 'dot' }
                };

                const layoutAAC = {
                    title: 'AAC Operational Range',
                    xaxis: {
                        title: {
                            text: 'Aerodynamic diameter, $$D_{\\mathrm{a}}$$ [nm]',
                            font: { size: 10 }
                        },
                        type: 'log',
                        range: [1, 3],
                        dtick: 1
                    },
                    yaxis: {
                        title: {
                            text: '$$R_{\\tau}$$',
                            font: { size: 8 }
                        },
                        type: 'log',
                        range: [0, 2],
                        dtick: 1
                    },
                    showlegend: true,
                    width: 800,
                    height: 600
                };

                const dataAAC = [
                    traceAACLower,
                    traceAACUpper,
                    traceAACHorizontalLower,
                    traceAACHorizontalUpper,
                    traceAACSelected
                ];

                Plotly.newPlot('aac-plot', dataAAC, layoutAAC);
            } catch (error) {
                console.error('Error in AAC_Trapezoidal:', error);
                alert('An error occurred during calculation. Please check the console for details.');
            }
        }

        function calculateAAC() {
            try {
                const Q_a = parseFloat(document.getElementById('aac-qa').value) / 60000;
                const Q_sh = parseFloat(document.getElementById('aac-qsh').value) / 60000;
                AAC_Trapezoidal(Q_a, Q_sh);
            } catch (error) {
                console.error('Error in calculateAAC:', error);
                alert('An error occurred during calculation. Please check the console for details.');
            }
        }

        // Calculate initial plot when page loads
        document.addEventListener('DOMContentLoaded', calculateAAC);
    </script>
</body>
</html> 